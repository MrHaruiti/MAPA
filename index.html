<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Painel de Voos - Aeroporto Hub</title>
  <style>
    body { margin: 0; font-family: sans-serif; display: flex; }
    #painel { width: 320px; background: #111; color: #fff; padding: 10px; height: 100vh; overflow-y: auto; }
    #aeroporto { flex: 1; background: #eee; position: relative; overflow: auto; }
    .aeronave-lista, .partida-lista {
      background: #222; padding: 8px; margin-bottom: 6px; border: 1px solid #444;
    }
    .autorizar { background: #0a0; color: #fff; border: none; padding: 5px; cursor: pointer; margin-top: 5px; }
    .pista {
      position: absolute; top: 50px; left: 50px; width: 800px; height: 30px; background: gray;
    }
    .terminal {
      position: absolute; width: 360px; display: flex; flex-wrap: wrap;
    }
    .posicao {
      width: 20px; height: 20px; margin: 2px; background: #ccc; border: 1px solid #999; position: relative;
    }
    .posicao.livre:hover { background: #8f8; cursor: pointer; }
    .aeronave {
      width: 20px; height: 20px; background: blue; color: white; font-size: 10px; text-align: center;
      line-height: 20px; position: absolute;
    }
    .tooltip {
      position: absolute; background: black; color: white; padding: 5px; font-size: 12px; display: none;
      z-index: 1000;
    }
  </style>
</head>
<body>
<div id="painel">
  <h2>Chegadas Programadas</h2>
  <div id="chegadas"></div>
  <h2>Partidas Disponíveis</h2>
  <div id="partidas"></div>
</div>
<div id="aeroporto" onclick="hideTooltip(event)">
  <div class="pista"></div>
  <div id="tooltip" class="tooltip"></div>
</div>

<script>
let chegadas = [], partidas = [];
const chegadasDiv = document.getElementById("chegadas");
const partidasDiv = document.getElementById("partidas");
const aeroporto = document.getElementById("aeroporto");
const tooltip = document.getElementById("tooltip");
let currentTarget = null;

function renderizarChegadas() {
  chegadasDiv.innerHTML = "";
  chegadas
    .filter(v => v.status === "Aguardando Autorizacao")
    .forEach((v) => {
      const div = document.createElement("div");
      div.className = "aeronave-lista";
      div.innerHTML = `<strong>${v.companhia} ${v.voo}</strong><br>De: ${v.cidade}<br>A/C: ${v.aeronave}<br>Horário: ${v.horario}<br>Status: ${v.status}<br><button class='autorizar'>Autorizar Pouso</button>`;
      div.querySelector("button").onclick = () => autorizarPouso(v);
      chegadasDiv.appendChild(div);
    });
}

function renderizarPartidas() {
  partidasDiv.innerHTML = "";
  partidas.filter(p => p.status === "Aguardando Associacao").forEach((v) => {
    const div = document.createElement("div");
    div.className = "partida-lista";
    div.innerHTML = `<strong>${v.companhia} ${v.voo}</strong><br>Para: ${v.cidade}<br>A/C: ${v.aeronave}<br>Horário: ${v.horario}<br>Status: ${v.status}`;
    partidasDiv.appendChild(div);
  });
}

function autorizarPouso(voo) {
  voo.status = "Pousando";
  renderizarChegadas();
  const el = document.createElement("div");
  el.className = "aeronave";
  el.innerText = voo.voo;
  el.style.top = "50px";
  el.style.left = "60px";
  el.dataset.info = JSON.stringify(voo);
  aeroporto.appendChild(el);
  let left = 60;
  const animar = setInterval(() => {
    left += 2;
    el.style.left = left + "px";
    if (left >= 150) {
      clearInterval(animar);
      voo.status = "Taxiando";
      taxiToTerminal(el, voo);
    }
  }, 20);
  el.onclick = (evt) => { evt.stopPropagation(); selecionarPartida(el, voo); };
}


function taxiToTerminal(el, voo) {
  let top = 50;
  const animarTaxi = setInterval(() => {
    top += 2;
    el.style.top = top + "px";
    if (top >= 250) {
      clearInterval(animarTaxi);
      voo.status = "Aguardando Alocacao";
      el.style.background = "orange";
      el.dataset.info = JSON.stringify(voo);

      // Mostrar instrução para escolher posição
      alert("Selecione uma posição livre para estacionar a aeronave.");

      // Liberar seleção de posição
      document.addEventListener("click", function alocarPosicao(e) {
        if (e.target.classList.contains("posicao") && e.target.classList.contains("livre")) {
          el.style.top = (e.target.offsetTop + e.target.parentElement.offsetTop) + "px";
          el.style.left = (e.target.offsetLeft + e.target.parentElement.offsetLeft) + "px";
          el.style.background = "blue";
          voo.status = "Estacionado";
          voo.estacionado = true;
          el.dataset.info = JSON.stringify(voo);
          e.target.classList.remove("livre");

          // Ativar clique no avião
          el.onclick = (evt) => {
            evt.stopPropagation();
            selecionarPartida(el, voo);
          };

          // Botão para mover a aeronave de posição
          const moverBtn = document.createElement("button");
          moverBtn.textContent = "Trocar Posição";
          moverBtn.style.position = "absolute";
          moverBtn.style.left = el.style.left;
          moverBtn.style.top = (parseInt(el.style.top) + 25) + "px";
          moverBtn.style.zIndex = 1000;
          moverBtn.onclick = () => {
            alert("Clique em uma nova posição livre para mover a aeronave.");
            document.addEventListener("click", function mover(e2) {
              if (e2.target.classList.contains("posicao") && e2.target.classList.contains("livre")) {
                el.style.top = (e2.target.offsetTop + e2.target.parentElement.offsetTop) + "px";
                el.style.left = (e2.target.offsetLeft + e2.target.parentElement.offsetLeft) + "px";
                e2.target.classList.remove("livre");
                moverBtn.remove();
                document.removeEventListener("click", mover);
              }
            });
          };
          aeroporto.appendChild(moverBtn);

          document.removeEventListener("click", alocarPosicao);
        }
      });
    }
  }, 20);
}
  }, 20);
}

function selecionarPartida(el, voo) {
  const popup = document.createElement("div");
  popup.style.position = "fixed";
  popup.style.top = "50%";
  popup.style.left = "50%";
  popup.style.transform = "translate(-50%, -50%)";
  popup.style.background = "#222";
  popup.style.color = "#fff";
  popup.style.padding = "20px";
  popup.style.border = "2px solid #555";
  popup.style.zIndex = 1001;
  popup.innerHTML = `<strong>Selecionar Partida para ${voo.voo}</strong><br><br>`;

  const filtro = document.createElement("input");
  filtro.placeholder = "Filtrar por destino ou voo...";
  filtro.style.width = "100%";
  filtro.style.marginBottom = "10px";
  popup.appendChild(filtro);

  const select = document.createElement("select");
  select.style.width = "100%";
  popup.appendChild(select);

  function atualizarSelect() {
    select.innerHTML = "";
    const texto = filtro.value.toLowerCase();
    partidas.filter(p => p.status === "Aguardando Associacao" && p.companhia === voo.companhia && p.aeronave === voo.aeronave && (
      p.voo.toLowerCase().includes(texto) ||
      p.cidade.toLowerCase().includes(texto) ||
      p.aeronave.toLowerCase().includes(texto)
    )).forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = `${p.voo} - ${p.cidade} - ${p.horario}`;
      select.appendChild(opt);
    });
  }

  filtro.oninput = atualizarSelect;
  atualizarSelect();

  const btnConfirmar = document.createElement("button");
  btnConfirmar.textContent = "Confirmar";
  btnConfirmar.style.margin = "10px";
  btnConfirmar.onclick = () => {
    const escolhido = partidas.find(p => p.id === select.value);
    if (escolhido) {
      escolhido.status = "Programado";
      el.title = `Partida para ${escolhido.cidade} ${escolhido.horario}`;
      renderizarPartidas();
    }
    document.body.removeChild(popup);
  };
  popup.appendChild(btnConfirmar);

  const cancelar = document.createElement("button");
  cancelar.textContent = "Fechar";
  cancelar.onclick = () => document.body.removeChild(popup);
  popup.appendChild(cancelar);

  document.body.appendChild(popup);
}

function hideTooltip(e) {
  if (e.target !== currentTarget && !tooltip.contains(e.target)) {
    tooltip.style.display = "none";
    currentTarget = null;
  }
}

function criarTerminais() {
  const totalTerminais = 10;
  const posicoesPorTerminal = 36;
  for (let t = 0; t < totalTerminais; t++) {
    const term = document.createElement("div");
    term.className = "terminal";
    const isTopo = t < 5;
    term.style.top = isTopo ? "100px" : "600px";
    term.style.left = (100 + (t % 5) * 400) + "px";
    for (let p = 1; p <= posicoesPorTerminal; p++) {
      const pos = document.createElement("div");
      pos.className = "posicao livre";
      pos.dataset.terminal = "T" + (t + 1);
      pos.dataset.portao = "G" + p;
      term.appendChild(pos);
    }
    aeroporto.appendChild(term);
  }
}

document.addEventListener("DOMContentLoaded", () => {
  criarTerminais();

  fetch("backup_voos.json")
    .then(r => r.json())
    .then(data => {
      chegadas = data.chegadas.map((v, i) => ({...v, id: "CHG" + i, status: "Aguardando Autorizacao"}));
      partidas = data.partidas.map((v, i) => ({...v, id: "PRT" + i, status: "Aguardando Associacao"}));
      renderizarChegadas();
      renderizarPartidas();
    });

  document.addEventListener("click", (e) => {
    if (e.target.classList.contains("posicao") && e.target.classList.contains("livre")) {
      const aeronaves = Array.from(document.querySelectorAll(".aeronave")).filter(a => a.style.background === "orange");
      if (aeronaves.length === 0) return;
      const aeronave = aeronaves[0];
      const pos = e.target;
      aeronave.style.top = (pos.offsetTop + pos.parentElement.offsetTop) + "px";
      aeronave.style.left = (pos.offsetLeft + pos.parentElement.offsetLeft) + "px";
      aeronave.style.background = "blue";
      pos.classList.remove("livre");
    }
  });
});
</script>
</body>
</html>
